---
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: create build signer key-task
spec:
  params:
  - name: registry-namespace
    description: The namespace in the container image registry. You can set it up
      with {bx cr namespace-add]. Learn more at https://cloud.ibm.com/docs/services/Registry?topic=registry-getting-started#getting-started.
  - name: registry-region
    description: The IBM Cloud region for image registry
  - name: api-key
    description: The IBM Cloud API key is used to access the IBM Cloud Kubernetes
      Service API and interact with the cluster. You can obtain your API key with
      'bx iam api-key-create' or via the console at https://cloud.ibm.com/iam#/apikeys
      by clicking **Create API key** (Each API key only can be viewed once).
  - name: prod-resource-group
    description: The IBM Cloud resource group for production deployment
  - name: vault_name
    description: Specify a Key Protect instance name.  If an instance has already
      been created, the existing one will be used, otherwise a new one will be created.
      You can specify signer names in the build and validation fields below or use
      the default values.
  - name: repository
    description: The git repo
  - name: prod-region
    description: The IBM Cloud region for production deployment
  - name: app-name
    description: '#/messages/deploy.appDescription'
  - name: revision
    description: the branch for the gir repo
  steps:
  - name: clone-step
    image: alpine/git
    command: ["/bin/sh", "-c"]
    args:
    - set -e -o pipefail;
          echo "Cloning $REPOSITORY";
          git clone -q -b $REVISION $REPOSITORY .;
    env:
    - name: REPOSITORY
      value: $(inputs.params.repository)
    - name: REVISION
      value: $(inputs.params.revision)
  - name: Create Build Signer Key
    image: ibmcom/pipeline-base-image:latest
    command: ["/bin/sh+","-c"]
    args:
      - #!/bin/bash
        echo "RUNNING";
    env:
    - name: VAULT_INSTANCE
      value: $(inputs.params.vault_name)
    - name: REVISION
      value: $(inputs.params.master)
    - name: VALIDATION_SIGNER
      value: $(inputs.params.validation_signer)
    - name: API_KEY
      value: $(inputs.params.api-key)
    - name: BUILD_REGION_ID
      value: $(inputs.params.prod-region)
    - name: BUILD_RESOURCE_GROUP
      value: $(inputs.params.prod-resource-group)
    - name: APP_NAME
      value: $(inputs.params.app-name)
    - name: REPOSITORY
      value: $(inputs.params.com/huayuenh/keyAdminAutoConvertedTekton)
    - name: REGISTRY_NAMESPACE
      value: $(inputs.params.registry-namespace)
    - name: BUILD_SIGNER
      value: $(inputs.params.build_signer)
    - name: GIT_REPO
      value: $(inputs.params.repo)
    volumeMounts:
    - monthPath: /artifacts
      name: task-volume
  volumes:
  - name: task-volume
    persistentVolumeClaim:
      name: $(inputs.params.task-pvc)